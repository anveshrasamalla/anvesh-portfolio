<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SFMC Form Test</title>

    <!-- IMPORTANT: AEM inserts CSRF token here -->
    <meta name="cq-csrf-token" content="${csrfToken}">

    <script src="https://www.google.com/recaptcha/api.js?render=YOUR_SITE_KEY_HERE" async defer></script>

    <style>
        body {font-family: Arial;background:#0f172a;color:#e5e7eb;padding:40px;}
        .container {max-width:650px;margin:auto;background:#111827;padding:24px;border-radius:8px}
        input,textarea {width:100%;padding:9px;margin-bottom:12px;background:#020617;color:#fff;border:1px solid #4b5563;border-radius:4px}
        button {padding:10px 16px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer}
        pre {background:#020617;padding:12px;border-radius:6px;color:#fff;white-space:pre-wrap}
    </style>
</head>
<body>

<div class="container">
    <h1>SFMC Form Test</h1>

    <form id="sfmcForm" action="/bin/wcm/sfmc" method="post">

        <label>Email</label>
        <input type="email" name="EmailAddress" value="test@example.com" required>

        <label>Phone</label>
        <input type="text" name="Phone" value="1234567890">

        <label>Message Body</label>
        <textarea name="MessageBody" rows="3">Some optional message body text.</textarea>

        <input type="hidden" name="FormID" value="AEM-Test-Form-001">

        <!-- reCAPTCHA token -->
        <input type="hidden" id="recapToken" name="g-recaptcha-response" value="">

        <button id="submitBtn">Submit</button>
    </form>

    <pre id="sfmcResult">Response will appear here…</pre>
</div>

<script>
(function() {

    var SITE_KEY = "YOUR_SITE_KEY_HERE";
    var form = document.getElementById("sfmcForm");
    var resultBox = document.getElementById("sfmcResult");
    var submitBtn = document.getElementById("submitBtn");
    var recapField = document.getElementById("recapToken");
    var csrf = document.querySelector("meta[name='cq-csrf-token']").content;

    form.addEventListener("submit", function(e) {
        e.preventDefault();

        resultBox.textContent = "Getting reCAPTCHA…";

        grecaptcha.ready(function() {
            grecaptcha.execute(SITE_KEY, { action: "submit" })
                .then(function(token) {

                    recapField.value = token;

                    var formData = new FormData(form);

                    // **CRITICAL FIX**
                    formData.append(":cq_csrf_token", csrf);

                    resultBox.textContent = "Submitting to servlet…";

                    fetch("/bin/wcm/sfmc", {
                        method: "POST",
                        body: formData,
                        credentials: "same-origin"
                    })
                    .then(resp => resp.text().then(text => ({ status: resp.status, text })))
                    .then(resp => {

                        try {
                            var json = JSON.parse(resp.text);
                            resultBox.textContent =
                                "Message: " + json.message + "\n" +
                                "Error: "   + json.error + "\n"   +
                                "HTTP: "    + json.httpCode + "\n" +
                                "RequestId: " + json.requestId + "\n\n" +
                                JSON.stringify(json, null, 2);
                        } catch (ex) {
                            // AEM returned HTML (400, 500, filter blocked)
                            resultBox.textContent =
                                "Non-JSON response (" + resp.status + "):\n\n" +
                                resp.text;
                        }
                    })
                    .catch(err => {
                        resultBox.textContent = "Network error: " + err;
                    });

                });
        });

    });

})();
</script>

</body>
</html>

<!-- Render PRIVATE fields -->
<sly data-sly-list.pf="${resource.getChild('privateFields').listChildren}">
    <input type="hidden" 
           name="${pf.valueMap['element-name']}" 
           value="${pf.valueMap['value']}" />
</sly>

<!-- Render HIDDEN fields -->
<sly data-sly-list.hf="${resource.getChild('hiddenFields').listChildren}">
    <input type="hidden"
           name="${hf.valueMap['element-name']}"
           value="${hf.valueMap['value']}" />
</sly>
