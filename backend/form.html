<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>SFMC Form – Prod Test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f7fafc; margin:0; padding:40px; }
    .card { max-width:720px; margin:0 auto; background:#fff; border:1px solid #e2e8f0; border-radius:10px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    h1 { margin:0 0 12px; font-size:20px; color:#2563eb; }
    label { display:block; margin:10px 0 6px; font-weight:600; }
    input, textarea { width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; font-size:14px; }
    button { margin-top:12px; background:#2563eb; color:#fff; border:0; border-radius:6px; padding:10px 16px; cursor:pointer; }
    pre { margin-top:14px; background:#0b1020; color:#c8e1ff; padding:12px; border-radius:8px; overflow:auto; font-size:13px; }
  </style>
  <!-- reCAPTCHA v3 -->
  <script src="https://www.google.com/recaptcha/api.js?render=YOUR_RECAPTCHA_SITE_KEY" async defer></script>
</head>
<body>
  <div class="card">
    <h1>SFMC Submission Test</h1>
    <form id="sfmcForm" action="/bin/wcm/sfmc" method="POST" novalidate>
      <!-- You can override this from component dialog if needed -->
      <input type="hidden" name="de_key" value="AEM-FORM-ENDPNT-INTRNL-TEST">
      <input type="hidden" name="MessageBody" id="MessageBody">

      <label>FormID
        <input name="FormID" value="education not for profit">
      </label>
      <label>Email
        <input name="Email" type="email" value="john@example.com">
      </label>
      <label>FirstName
        <input name="FirstName" value="John">
      </label>
      <label>LastName
        <input name="LastName" value="Doe">
      </label>
      <label>Comments
        <textarea name="Comments" rows="3">Optional comments…</textarea>
      </label>

      <button id="submitBtn" type="submit">Submit</button>
    </form>

    <pre id="out">Waiting…</pre>
  </div>

  <script>
  (function () {
    const form = document.getElementById('sfmcForm');
    const out  = document.getElementById('out');
    const btn  = document.getElementById('submitBtn');
    const siteKey = 'YOUR_RECAPTCHA_SITE_KEY';

    function setOut(o){ out.textContent = (typeof o==='string') ? o : JSON.stringify(o, null, 2); }

    function buildMessageBody(form) {
      const parts = [];
      const fields = form.querySelectorAll('input, textarea, select');
      for (var i=0;i<fields.length;i++) {
        var el = fields[i];
        if (!el.name || el.type === 'hidden') continue;
        var v = (el.value || '').trim();
        if (v) parts.push((el.name + ':').padEnd(18, ' ') + v);
      }
      return parts.join('\r\n');
    }

    async function getCsrf() {
      try {
        const r = await fetch('/libs/granite/csrf/token.json', { credentials: 'same-origin' });
        if (!r.ok) return null;
        const j = await r.json();
        return j.token || null;
      } catch { return null; }
    }

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      document.getElementById('MessageBody').value = buildMessageBody(form);

      btn.disabled = true; btn.textContent = 'Submitting…'; setOut('Submitting…');

      Promise.resolve(getCsrf()).then(function (csrf) {
        grecaptcha.ready(function () {
          grecaptcha.execute(siteKey, { action: 'submit' }).then(function (recaptchaToken) {
            const fd = new FormData(form);
            fd.append('g-recaptcha-response', recaptchaToken);

            fetch(form.action, {
              method: 'POST',
              headers: csrf ? { 'CSRF-Token': csrf } : {},
              body: fd,
              credentials: 'same-origin'
            })
            .then(function (res) { return res.text().then(function(t){ return { ok: res.ok, t: t }; }); })
            .then(function (r) {
              try { setOut(JSON.parse(r.t)); } catch { setOut(r.t); }
            })
            .catch(function (err) { setOut({ error:true, message: err.message }); })
            .finally(function(){ btn.disabled = false; btn.textContent = 'Submit'; });
          });
        });
      });
    });
  })();
  </script>
</body>
</html>
